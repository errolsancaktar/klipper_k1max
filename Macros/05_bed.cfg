## Bed Meshing and Soaking ##
## 05_bed.cfg ##
## Printer: K1 Max (Customized) ##

[gcode_macro BED_PROFILE_CHECK]
description: Loads mesh profile if it exists for the requested temp, otherwise runs BED_MESH and saves it.
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set REQUIRED_BED_TEMP = params.BED_TEMP | float %}
    {% set REQUIRED_EXTRUDER_TEMP = params.EXTRUDER_TEMP | default(VARS.meshing_temp) | float %}

    SET_GCODE_VARIABLE MACRO=PRINTER_VARS VARIABLE=mesh_is_new VALUE=0
    
    ; 1. Construct the profile name
    {% set PREFIX = VARS.mesh_profile_prefix | default('bed_') %}
    {% set PROFILE_NAME = PREFIX ~ REQUIRED_BED_TEMP|int %}
    
    ; 2. Check if the constructed profile name exists
    {% if PROFILE_NAME in printer.bed_mesh.profiles %}
        M117 Found profile: {PROFILE_NAME}. Loading mesh...
        ENSURE_HOMED
        BED_MESH_PROFILE LOAD="{PROFILE_NAME}"
        M117 Mesh loaded. Proceeding to print.

    {% else %}
        M117 Profile {PROFILE_NAME} not found. Running full mesh calibration...

        SET_GCODE_VARIABLE MACRO=PRINTER_VARS VARIABLE=mesh_is_new VALUE=1

        BED_MESH BED_TEMP={REQUIRED_BED_TEMP} EXTRUDER_TEMP={REQUIRED_EXTRUDER_TEMP} PROFILE="{PROFILE_NAME}"
        
        M117 Calibration complete and new mesh saved as {PROFILE_NAME}.
    {% endif %}

[gcode_macro BED_MESH]
description: >
    Custom bed mesh macro. Executes full calibration with temperature and geometry checks.
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set params = params|default({}) %}

    {% set required_bed_temp = params.BED_TEMP | default(80) | float %}
    {% set required_extruder_temp = params.EXTRUDER_TEMP | default(VARS.meshing_temp) | float %}
    
    {% set profile_name = params.PROFILE | default('default') | string %}
    
    M117 Starting custom bed mesh...
    
    ENSURE_HOMED
    BED_MESH_CLEAR

    RESPOND PREFIX="BED_MESH" MSG="Waiting for Meshing Temps: E{required_extruder_temp} B{required_bed_temp}"
    
    M190 S{required_bed_temp}  ; blocking

    BED_MESH_CALIBRATE 

    BED_MESH_PROFILE SAVE={profile_name}
    M117 Bed Mesh Calibration Complete.

[gcode_macro BED_SOAK]
description: Manages bed heating and soaking with conditional 5-minute soak.
variable_last_start_temp: 0
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set start = params.START|default(0)|int %}
    {% set wait = params.WAIT|default(0)|int %}
    {% set target_temp = params.TARGET_TEMP|default(VARS.bed_target)|float %}
    {% set overshoot = VARS.bed_overshoot|default(10)|float %}
    {% set fan_speed = 255 %}
    {% set TOLERANCE = 5.0 %}
    
    # Get the current bed temp
    {% set current_bed_temp = printer.heater_bed.temperature %}

    {% if start == 1 %}
        SET_GCODE_VARIABLE MACRO=BED_SOAK VARIABLE=last_start_temp VALUE={current_bed_temp}
        M140 S{target_temp + overshoot} 
        M117 Bed heating to soak temp ({current_bed_temp|round(1)}C)...
    {% endif %}

    {% if wait == 1 %}
        M117 Waiting for bed soak to complete...
        M106 S{fan_speed}
        M140 S{target_temp} 
        
        {% set MIN_TEMP = target_temp - TOLERANCE %}
        {% set MAX_TEMP = target_temp + TOLERANCE %}
        
        M117 Waiting for bed temp ({MIN_TEMP|round(1)}C to {MAX_TEMP|round(1)}C)...
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={MIN_TEMP} MAXIMUM={MAX_TEMP}
        
        # --- CONDITIONAL SOAK ---
        # Check if the bed was below 40
        {% if printer["gcode_macro BED_SOAK"].last_start_temp < 40 %}
            RESPOND PREFIX="BED_SOAK" MSG="Cold start detected (<40C). Soaking for 5 mins..."
            M400
            G4 S300
        {% else %}
            RESPOND PREFIX="BED_SOAK" MSG="Warm start detected. Skipping timed soak."
        {% endif %}
        # ------------------------------
        
        M106 S0
        RESPOND PREFIX="BED_SOAK" MSG="Bed soak complete."
    {% endif %}

[gcode_macro SET_MESH_PROFILE]
description: Sets the name of the bed mesh profile to be loaded by START_PRINT.
gcode:
    {% set profile_name = params.NAME|default("")|string %}

    SET_GCODE_VARIABLE MACRO=PRINTER_VARS VARIABLE=mesh_to_load VALUE="{profile_name}"
    
    {% if profile_name|length > 0 %}
        RESPOND PREFIX="MESH_PROFILE" MSG="Next print will load mesh: {profile_name}"
    {% else %}
        RESPOND PREFIX="MESH_PROFILE" MSG="Next print will use full bed mesh calibration."
    {% endif %}    
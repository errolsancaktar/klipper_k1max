[gcode_macro NOZZLE_CLEAN]
description: >
    Performs wipe using PRINTER_VARS coordinates. Sets temp non-blocking to meshing_temp.
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set start = params.START | default(0) | int %}
    {% set wait = params.WAIT | default(1) | int %}
    
    {% set required_temp = VARS.leveling_temp | float %}
    {% set x_start = VARS.clean_x_start | float %}
    {% set y_wipe = VARS.clean_y_wipe | float %}
    {% set z_wipe = VARS.clean_z_wipe | default(0.0) | float %} 
    {% set wipe_width = VARS.bed_wipe_width | default(20) | float %}
    {% set z_safe = VARS.z_safe_travel | default(10) | float %}

    SAVE_GCODE_STATE NAME=CLEAN_STATE
    
    {% if start == 1 %}
        M117 "Heating nozzle to leveling temp: {required_temp}C..."
        M104 S{required_temp}
    {% endif %}

    {% if wait == 1 %}
        M117 "Performing nozzle clean..."
        
        {% if printer.extruder.temperature < required_temp or printer.extruder.target < required_temp %}
            M109 S{required_temp}
        {% endif %} 

        G90
        G0 Z{z_safe} F6000                 ; Lift Z to safe travel height (Absolute)
        G0 X{x_start} Y{y_wipe} F6000      ; Move quickly to wipe start X/Y
        
        G0 Z{z_wipe} F600                  ; Move down to wipe Z height (Absolute, final Z-height)
        
        M83
        G1 E1 F200                         ; Initial extrusion/purge
        M82

        M106 S255                          ; Part cooling fan ON
        
        ; --- 3. WIPE MOTION (2x Pass) ---
        G1 X{x_start - wipe_width} F1500   ; Wipe away (Pass 1)
        G1 X{x_start} E1 F1500             ; Wipe back and extrude slightly to clean tip (Pass 2)
        G1 X{x_start - wipe_width} F1500   ; Wipe away (Pass 3)
        M106 S0                            ; Turn off part fan
        M109 S{VARS.meshing_temp} 
        ; --- 4. Z-CLEAR AND TEMP SET ---
        G0 Z{z_safe} F3000                 ; Lift Z to safe height
        
        
    {% endif %}
    
    RESTORE_GCODE_STATE NAME=CLEAN_STATE MOVE=0 
    M117 Nozzle Cleaning Complete

[gcode_macro NOZZLE_PRIME]
description: Performs nozzle prime. Uses starting X/Y/Z from PRINTER_VARS.
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    
    ; Define settings
    {% set z_safe = VARS.z_safe_travel | default(10.0) | float %}
    {% set prime_start_x = VARS.prime_x | default(298)|float %}
    {% set prime_start_y = VARS.prime_y | default(0)|float %}
    {% set x_end = prime_start_x - 150 %}
    {% set z_prime_height = VARS.clean_z_touch | default(0.2)|float %} 
    
    {% set TRAVEL_SPEED = 6000 %}
    {% set EXTRUDE_SPEED_FAST = 600 %} 
    {% set EXTRUDE_SPEED_SLOW = 1500 %}

    M117 "Priming nozzle..."
    
    G90 ; Ensure absolute coordinates for movement
    G92 E0 ; Reset Extruder position to 0 (Critical Step 1)

    ; 1. Move to starting X/Y/Z safe height
    ; Removed SAFE_MOVE complexity, as START_PRINT has ensured safety/homing.
    G0 Z{z_safe} F{TRAVEL_SPEED}
    G0 X{prime_start_x} Y{prime_start_y} F{TRAVEL_SPEED}
    
    ; 2. Move down to priming height
    G0 Z{z_prime_height} F600
    
    ; 3. Initial Extrusion (Purge Blob)
    M83 ; â­ FIX: Force Relative Extrusion Mode
    G1 E2 F{EXTRUDE_SPEED_FAST} ; Purge 2mm slowly
    
    ; 4. Prime line motion
    G1 X{x_end} F{EXTRUDE_SPEED_SLOW} E10 ; Extrude 10mm while moving
    
    ; 5. Final Retract and Lift
    G1 E-0.5 F3000 ; Quick retract to prevent stringing
    M82 ; Restore Absolute Extrusion Mode (Slicer expects this state if M83 is not in START_PRINT)
    
    G0 Z{z_safe} F3000 ; Lift back to the safe travel height
    
    G92 E0 ; Final reset of extruder position before slicer G-code takes over
    M117 "Nozzle prime complete."
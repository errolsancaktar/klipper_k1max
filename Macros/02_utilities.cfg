; =============================
; 03_utilities.cfg
; UTILITY & HELPER MACROS
; =============================

[gcode_macro GET_CURRENT_TEMP]
description: Report current extruder and bed temperatures
gcode:
    {% set E = printer.extruder.temperature|round(1) %}
    {% set T = printer.extruder.target|round(1) %}
    {% set B = printer.heater_bed.temperature|round(1) %}
    {% set BT = printer.heater_bed.target|round(1) %}
    RESPOND MSG="Extruder T={E}°C (target {T}°C) | Bed T={B}°C (target {BT}°C)"


[gcode_macro TURN_OFF_FANS]
description: Safely sets all configured fans (part, controller, generic) to 0.
gcode:
    M117 Shutting down all fans...

    ; --- 1. Part Cooling Fan (Standard 'fan') ---
    {% if printer.fan %}
        M106 S0
        M117 Part fan off.
    {% endif %}

    ; --- 2. Generic Fans (fan_generic) ---
    {% for fan_name, fan_status in printer.fan_generic|default({})|dictsort %}
        M106 FAN={fan_name} S0 ; <--- Corrected M106 syntax for generic fans
        M117 Generic fan {fan_name} off.
    {% endfor %}

    ; --- 3. Heater Fans (heater_fan) ---
    {% for fan_name, fan_status in printer.heater_fan|default({})|dictsort %}
        SET_FAN_SPEED FAN={fan_name} SPEED=0
        M117 Heater fan {fan_name} off.
    {% endfor %}
    
    ; --- 4. Toolhead Fan (If defined as fan_generic) ---
    {% if 'toolhead_fan' in printer.fan_generic|default({}) %}
        M106 FAN=toolhead_fan S0 ; <--- Corrected M106 syntax for generic fans
        M117 Toolhead fan off.
    {% endif %}
    
    M117 All fans secured.


[gcode_macro DUMP_VARS]
description: Dumps all Klipper variables to the console, useful for debugging macros.
gcode:
    {% set filter_name = params.NAME|default('')|string|lower %}
    {% set filter_value = params.VALUE|default('')|string|lower %}
    {% set show_cfg = params.SHOW_CFG|default(0)|int %}
    
    {% set out = [] %}

    {% for key1 in printer %}
        {% for key2 in printer[key1] %}
            {% if (show_cfg or not (key1|lower == 'configfile' and key2|lower in ['config', 'settings'])) and (filter_name in key1|lower or filter_name in key2|lower) and filter_value in printer[key1][key2]|string|lower %}
                {% set dummy = out.append("printer['%s'].%s = %s" % (key1, key2, printer[key1][key2])) %}
            {% endif %}
        {% else %}
            {% if filter_name in key1|lower and filter_value in printer[key1]|string|lower %}
                {% set dummy = out.append("printer['%s'] = %s" % (key1, printer[key1])) %}
            {% endif %}
        {% endfor %}
    {% endfor %}
    
    {action_respond_info(out|join("\n"))}


[gcode_macro PSTATUS]
description: Print status of a printer property
gcode:
    {% set info = None %}
    {% if params.S1 is defined and params.S2 is defined %}
        {% set info = printer[params.S1][params.S2] %}
    {% elif params.S1 is defined %}
        {% set info = printer[params.S1] %}
    {% else %}
        {% set info = printer.idle_timeout.state %}
    {% endif %}
    {action_respond_info(info|string)}


[gcode_macro SET_QMODE]
description: Placeholder for Q‑mode (fan/behavior control) compatibility
gcode:
    RESPOND MSG="SET_QMODE executed (no operation)"



[gcode_macro RESPOND]
rename_existing: BASE_RESPOND
gcode:
    ; --- SIMPLIFIED RESPOND MACRO (Removing complex and non-standard HTML injection) ---
    BASE_RESPOND {% for p in params %}{p}={% if params[p] is string %}"{params[p]|replace('"', '\\"') }"{% else %}{ params[p] }{% endif %} {% endfor %}



[gcode_macro AUX_COOL_DOWN]
description: Runs aux_fan (P2) until the bed is below a target temperature.
gcode:
    {% set TARGET_TEMP = params.TEMP|default(40)|float %}
    {% set MAX_FAN_SPEED = 1.0 %}

    M117 "Aux Cooling: Waiting for bed < {TARGET_TEMP}C..."

    ; 1. Turn Aux Fan ON
    SET_FAN_SPEED FAN=AUX SPEED={MAX_FAN_SPEED}

    ; 2. Wait for the bed temperature to drop below the target.
    ;    The command waits for the named heater (heater_bed) to drop 
    ;    BELOW the specified target (T={TARGET_TEMP}).
    TEMPERATURE_WAIT SENSOR=heater_bed T={TARGET_TEMP}

    ; 3. Turn Aux Fan OFF
    SET_FAN_SPEED FAN=AUX SPEED=0.0

    M117 "Aux Cooling: Finished. Bed is below {TARGET_TEMP}C."

[gcode_macro EXHAUST_FAN_CONTROL]
description: Control chamber/exhaust fan based on filament type
gcode:
    {% set FIL = params.FILAMENT|default("PLA") %}
    {% set NO_COOL = ["ABS","ASA","NYLON"] %}
    {% if FIL in NO_COOL %}
        SET_FAN_SPEED FAN=exhaust_fan SPEED=0
    {% else %}
        SET_FAN_SPEED FAN=exhaust_fan SPEED=1
    {% endif %}


[gcode_macro _SET_XY_HOMING_CURRENT]
description: Temporarily sets low current and SGTHRS for homing.
gcode:
    {% if printer['gcode_macro xyz_ready'].tuning_mode|int == 0 %}
        {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
        {% set CURRENT = VARS.homing_current|default(0.6)|float %}
        {% set SGTHRS_X = VARS.sgthrs_x|default(100)|int %}
        {% set SGTHRS_Y = VARS.sgthrs_y|default(95)|int %}

        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={CURRENT}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={CURRENT}
        SET_TMC_FIELD STEPPER=stepper_x FIELD=SGTHRS VALUE={SGTHRS_X}
        SET_TMC_FIELD STEPPER=stepper_y FIELD=SGTHRS VALUE={SGTHRS_Y}
        M400
    {% endif %}

[gcode_macro _RESTORE_XY_RUN_CURRENT]
description: Restores the default run_current for X and Y after homing.
gcode:
    {% if printer['gcode_macro xyz_ready'].tuning_mode|int == 0 %}
        {% set run_x = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
        {% set run_y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={run_x}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={run_y}
        M400
    {% endif %}
    
[gcode_macro SET_E_MIN_CURRENT]
description: Lowers extruder motor current to reduce heat creep when idle.
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set e_current = VARS.e_min_current|default(0.5)|float %} 
    M400
    SET_TMC_CURRENT STEPPER=extruder CURRENT={e_current} HOLDCURRENT={e_current}
    G4 P2000

[gcode_macro RESTORE_E_CURRENT]
description: Restores extruder motor current to configured run_current.
gcode:
    {% if printer['gcode_macro xyz_ready'].tuning_mode|int == 0 %}
        {% set e_current = printer.configfile.settings['tmc2209 extruder'].run_current %}
        M400
        SET_TMC_CURRENT STEPPER=extruder CURRENT={e_current} HOLDCURRENT={e_current}
        G4 P2000
    {% endif %}

[gcode_macro _GET_COLLISION_RISK]
description: Returns 1 (True) if a print is active or paused, 0 (False) otherwise.
gcode:
    {% if printer.virtual_sdcard.is_active or ('pause_resume' in printer and printer["pause_resume"].is_paused|int == 1) %}
        {% set result = 1 %}
    {% else %}
        {% set result = 0 %}
    {% endif %}
    
    ; Note: This uses action_respond_info as a way to "return" the value
    ; to the calling macro's variable assignment.
    {action_respond_info("collision_risk_state: %d" % result)}    
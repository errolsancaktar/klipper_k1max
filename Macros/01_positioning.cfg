; =============================
; 01_positioning.cfg
; POSITIONING / PARK / TOOLHEAD
; =============================

[gcode_macro xyz_ready]
variable_x_ready: 0
variable_y_ready: 0
variable_z_ready: 0
variable_xy_moved: 0
variable_z_is_safe: 0
variable_tuning_mode: 0
gcode:


[gcode_macro _IF_HOME_Z]
description: Safely move Z before homing X/Y (critical for Z-Max homing).
gcode:
  {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
  {% set Z_SAFE_HEIGHT = VARS.z_safe_travel|default(10)|float %} 
  {% set Z_DROP_REL = VARS.z_homing_drop_rel|default(-10)|float %}
  {% set READY_VARS = printer['gcode_macro xyz_ready'] %}

  
  ; 1. Z Homing Safety Check (Toolhead high enough?)
  {% if 'z' in printer.toolhead.homed_axes and printer.toolhead.position.z|float < Z_SAFE_HEIGHT %}
      M117 Z Safety Lift: Lifting to {Z_SAFE_HEIGHT}mm...
      G90
      G1 Z{Z_SAFE_HEIGHT} F6000
  
  ; 2. Initial Z Drop for Z-MAX Homing Safety
  {% elif 'z' not in printer.toolhead.homed_axes and READY_VARS.z_is_safe|int == 0 %}
      {action_respond_info("Safety Z Drop: Lowering bed %smm (Once)" % Z_DROP_REL)}
      ; Use FORCE_MOVE to drop the bed (negative distance)
      FORCE_MOVE STEPPER=stepper_z DISTANCE={Z_DROP_REL} VELOCITY=10 
      SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=z_is_safe VALUE=1
  
  {% endif %}

[gcode_macro ENSURE_HOMED]
description: Homes the printer only if it isn't currently homed.
gcode:
    {% if printer.toolhead and "xyz" not in printer.toolhead.homed_axes %}
        M118 Homing required...
        G28
    {% else %}
        M118 Already homed.
    {% endif %}

[gcode_macro _TRAVERSE_TO_XY]
description: Executes a move by traversing via the nearest X axis boundary.
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set params = params|default({}) %}
    {% set norm_params = {} %}
    {% for key, value in params.items() %}{% set _ = norm_params.update({key|upper: value}) %}{% endfor %}

    ; --- 1. PARAMETER EXTRACTION ---
    {% set target_X = norm_params.X|default(None)|float %}
    {% set target_Y = norm_params.Y|default(None)|float %}
    {% set F = norm_params.F|default(6000)|float %}
    {% set MOVE_TYPE = norm_params.MOVE_TYPE|default("G0")|upper %}
    
    ; --- 2. SETUP AND CHECKS ---
    ENSURE_HOMED
    G90 ; absolute positioning
    {% set current_X = printer.toolhead.position.x|float %}
    {% set current_Y = printer.toolhead.position.y|float %}
    {% set current_Z = printer.toolhead.position.z|float %}
    
    ; --- 3. CALCULATE NEAREST X BOUNDARY ---
    {% set X_MIN = printer["toolhead"].axis_minimum.x | default(0.0) | float %}
    {% set X_MAX = printer["toolhead"].axis_maximum.x | default(300.0) | float %}
    
    {% if current_X - X_MIN < X_MAX - current_X %}
        {% set X_BOUNDARY = X_MIN %} ; Closer to X_MIN
        M118 Pathing via X_MIN ({X_BOUNDARY|round(2)}).
    {% else %}
        {% set X_BOUNDARY = X_MAX %} ; Closer to X_MAX
        M118 Pathing via X_MAX ({X_BOUNDARY|round(2)}).
    {% endif %}

    ; --- 4. EXECUTE THE PATHING SEQUENCE ---
    ; 4a. Move X to the nearest boundary (clearing the central area)
    G0 X{X_BOUNDARY} F{F}
    ; 4b. Move Y along the boundary to the requested Y position
    G0 Y{target_Y} F{F}
    ; 4c. Move X to the final target X position
    {MOVE_TYPE} X{target_X} F{F}
    M400 ; Wait for moves to complete

[gcode_macro SAFE_MOVE]
description: Vaidates and Moves Safely
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set params = params|default({}) %}
    {% set norm_params = {} %}
    {% for key, value in params.items() %}{% set _ = norm_params.update({key|upper: value}) %}{% endfor %}

    ; --- 1. CORE PARAMETER EXTRACTION ---
    {% set X = norm_params.X|default(None) %}
    {% set Y = norm_params.Y|default(None) %}
    {% set Z = norm_params.Z|default(None) %}
    {% set F = norm_params.F|default(printer.toolhead.max_velocity * 60)|float %}
    {% set MOVE_TYPE = norm_params.MOVE_TYPE|default("G0")|upper %}
    
    {% set Z_SAFE_LIFT = VARS.z_safe_travel|default(10.0)|float %}
    {% set Z_ORIGINAL = printer.toolhead.position.z|float %}
    
    ; --- Check if we need to restore Z at the end ---
    {% set RESTORE_Z = True if Z is none and Z_ORIGINAL < Z_SAFE_LIFT else False %}
    
    ; --- 2. PRE-MOVE SAFETY CHECKS ---
    ENSURE_HOMED
    G90 ; Ensure absolute positioning

    ; ===================================================================
    ; RULE: X/Y MOVE WITH BOUNDARY TRAVERSAL
    ; This logic executes only if X or Y coordinates are provided.
    ; ===================================================================
    {% if X is not none or Y is not none %}
        
        {% set current_X = printer.toolhead.position.x|float %}
        {% set current_Y = printer.toolhead.position.y|float %}
        {% set target_X = X|default(current_X)|float %}
        {% set target_Y = Y|default(current_Y)|float %}

        ; A. Z-Move Phase: Handle Z explicitly if given, or perform safe lift.
        {% if Z is not none %}
            M118 Moving Z to {Z}mm.
            G0 Z{Z} F6000
        {% else %}
            ; If Z is not given, lift to safe height if current Z is too low.
            {% if (current_X is not none or current_Y is not none) and Z_ORIGINAL < Z_SAFE_LIFT %}
                M117 Lifting Z to {Z_SAFE_LIFT}mm for travel.
                G0 Z{Z_SAFE_LIFT} F6000
            {% endif %}
        {% endif %}
        
        _TRAVERSE_TO_XY X={target_X|float} Y={target_Y|float}
        
    ; ===================================================================
    ; RULE D: Z-Only Move or No Parameters
    ; ===================================================================
    {% elif Z is not none %}
        M117 Z-only move.
        G0 Z{Z} F6000
        
    {% else %}
        M117 SAFE_MOVE completed or no motion parameters provided.
    {% endif %}

    M400 ; Wait for all moves to complete
    
    ; --- 3. Z-RESTORE PHASE ---
    ; If Z was not specified, but we lifted it for safe travel, return to original Z.
    {% if RESTORE_Z %}
        M117 Restoring Z to original height: {Z_ORIGINAL}mm.
        G0 Z{Z_ORIGINAL} F6000
    {% endif %}


[gcode_macro CENTER]
description: Move to center of build volume
gcode:
    G90
    SAFE_MOVE X={ printer.toolhead.axis_maximum.x/2 } Y={ printer.toolhead.axis_maximum.y/2 } F=12000
    G0 Z{ printer.toolhead.axis_maximum.z/2 } F7200


[gcode_macro PRESENT_TOOLHEAD]
description: Move toolhead to front-center for visibility
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    
    ENSURE_HOMED
    
    SAVE_GCODE_STATE NAME=PRESENT_STATE

    M117 Presenting Toolhead...
    
    G90
    SAFE_MOVE X={VARS.x_present|float} Y={VARS.y_present|float} F=6000 
    G0 Z{VARS.z_present|float} F6000

    M117 Printer Ready


[gcode_macro _PARK_POSITION]
description: Safely parks the printer using the safe traversal sequence and final rest position.
gcode:
    ; --- Variable Setup ---
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set SAFE_Z = [printer.toolhead.position.z + 20, printer.toolhead.axis_maximum.z]| min | float %}
    
    M117 "Parking: Initiating Safe Clearance and Parking Sequence..."

    ENSURE_HOMED
    G90

    
    M117 "Parking: Moving to parked position..."
    
    ; 2. Move to the final park coordinates using SAFE_MOVE
    SAFE_MOVE X={VARS.x_park|float} Y={VARS.y_park|float} Z={SAFE_Z} F=3600

    M117 "Parking Complete."

[gcode_macro PARK]
description: Safely parks the printer using the safe traversal sequence and final rest position.
gcode:
    _PARK_POSITION {rawparams}
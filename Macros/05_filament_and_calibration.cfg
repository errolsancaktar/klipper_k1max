; =============================
; 05_filament_and_calibration.cfg
; FILAMENT & CALIBRATION MACROS
; =============================
; =================================================
; I. CORE FILAMENT EXTRUSION SEQUENCES (Mechanical Action)
; These perform the physical E moves.
; =================================================

[gcode_macro _LOAD_FILAMENT_CORE]
description: Core sequence to push filament into the nozzle.
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    G91 ; Relative extrusion mode for E moves
    G92 E0
    G1 E10 F600
    G1 E{VARS.fast_distance} F{VARS.fast_speed}
    G1 E{VARS.purge_distance} F{VARS.load_speed}
    M400 ; Wait for moves to finish

[gcode_macro _UNLOAD_FILAMENT_CORE]
description: Core sequence to retract filament from the nozzle.
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    M83 ; Relative extrusion mode for E moves
    G92 E0
    G1 E{VARS.unload_bump} F300 
    G1 E-{VARS.retract_1_dist} F3000
    G1 E-{VARS.retract_2_dist} F{VARS.fast_speed} 
    G1 E-{VARS.retract_3_dist} F1200
    G1 E-{VARS.retract_4_dist} F720
    M400


; =================================================
; II. PUBLIC FILAMENT INTERFACE MACROS (Safety & Setup Logic)
; These handle homing, heating, parking, and current management.
; =================================================

[gcode_macro LOAD_FILAMENT]
description: Checks filament sensor and initiates loading or delay prompt.
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set TARGET_TEMP = params.TEMP|default(210)|float %}
    
    SAVE_GCODE_STATE NAME=_filament_loading

    M117 Filament Load: Heating to {TARGET_TEMP}°C...
    M104 S{TARGET_TEMP}
    
    ; 1. Move to park position
    SAFE_MOVE X={VARS.filament_load_x_pos} Y={VARS.filament_load_y_pos}
    
    ; 2. Heating wait (Block until ready)
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={TARGET_TEMP}
    RESTORE_E_CURRENT    ; Set E-Current high for robust extrusion

    ; 3. Sensor Check and Action
    {% set SENSOR_CHECK = 'filament_switch_sensor filament_sensor' in printer %}
    
    {% if SENSOR_CHECK %} 
        {% if printer['filament_switch_sensor filament_sensor'].filament_detected == True %}
            M117 Sensor detected filament. Starting auto-load...
            _LOAD_FILAMENT_CORE
        {% else %}
            M117 Sensor: No filament detected. Starting wait loop...
            DELAY_LOAD_FILAMENT TEMP={TARGET_TEMP}
        {% endif %}
    {% else %}
        M117 No sensor found. Assuming filament inserted, starting auto-load...
        _LOAD_FILAMENT_CORE
    {% endif %}
    
    ; 4. Cleanup (Runs after successful load OR after DELAY_LOAD_FILAMENT completes)
    SET_E_MIN_CURRENT
    RESTORE_GCODE_STATE NAME=_filament_loading
    M117 Filament loading process complete.
    
[gcode_macro DELAY_LOAD_FILAMENT]
description: Executes the waiting loop for filament sensor to turn True and continues load.
gcode:
    {% set LOADED=False %}
    {% if 'filament_switch_sensor filament_sensor' not in printer %}
        M117 Error: No filament sensor configured! Cannot run DELAY_LOAD.
        
    {% else %}       
        M117 Nozzle is HOT. Insert filament now.
        
        {% set wait_cycles = 15 %}
        {% set wait_pause = 4 %} 

        M117 Starting {wait_cycles} sensor check cycles (4s each)...
        ; G-code loop to pause execution. Sensor state is ONLY checked at the end.
        {% for i in range(wait_cycles) %}
            {% if LOADED %}
                M117 Waiting for insertion... ({wait_cycles - i} cycles left)
                G4 P{wait_pause * 1000} ; Pause G-code execution
                {% if printer['filament_switch_sensor filament_sensor'].filament_detected == True %}
                    M117 Timeout finished. Filament DETECTED! Continuing LOAD_FILAMENT...
                
                    ; *** CRITICAL: Run the core sequence directly ***
                    _LOAD_FILAMENT_CORE 
                
                {% else %}
                    M117 Timeout! Filament still NOT detected. Proceeding to Load anyway...
                    _LOAD_FILAMENT_CORE
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}

[gcode_macro UNLOAD_FILAMENT]
description: Heats and automatically unloads filament. Use TEMP=...
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set TARGET_TEMP = params.TEMP|default(VARS.load_unload_temp)|int %}
    {% set Z_PARK = VARS.z_safe_travel|default(10)|float %}
    {% set MIN_EXTRUDE = [TARGET_TEMP, 180]|max %}
    ; --- 1. FILAMENT DETECTION CHECK ---
    {% set UNLOAD_REQUIRED = True %}
    
    {% if 'filament_switch_sensor filament_sensor' in printer %} 
        {% if printer['filament_switch_sensor filament_sensor'].filament == False %}
            {% set UNLOAD_REQUIRED = False %}
            M117 Sensor: No filament detected. Skipping unload.
        {% endif %}
    {% endif %}

    ; --- 2. EXECUTE UNLOAD SEQUENCE (Only if required) ---
    {% if UNLOAD_REQUIRED %}
        
        SAVE_GCODE_STATE NAME=_filament_unloading
        M117 Unload: Pre-heating to {TARGET_TEMP}°C...
        M104 S{TARGET_TEMP} ; Heat
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={MIN_EXTRUDE}
        
        {% if printer.toolhead.position.z < Z_PARK %}
            {% if _GET_COLLISION_RISK %}
                G0 Z{Z_PARK} F6000
            {% else %}
                FORCE_MOVE STEPPER=stepper_z DISTANCE={Z_PARK} VELOCITY=10
            {% endif %}
        {% endif %}

        RESTORE_E_CURRENT ; Set motor current to full run_current
        _UNLOAD_FILAMENT_CORE
        SET_E_MIN_CURRENT ; Lower current after finished retraction
        
        RESTORE_GCODE_STATE NAME=_filament_unloading
        M117 Filament unloaded!
    {% else %}
        M117 Unload process Skipped.
    {% endif %}

[gcode_macro CHANGE_FILAMENT]
description: Pause print, UNLOAD, wait for new filament, LOAD, and RESUME.
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set TARGET_TEMP = params.TEMP|default(VARS.load_unload_temp)|float %}
    
    M117 Starting Filament Change procedure...
    # PAUSE

    M118 Checking/Unloading old filament...
    UNLOAD_FILAMENT TEMP={TARGET_TEMP}

    DELAY_LOAD_FILAMENT TEMP={TARGET_TEMP}
    
    {% if _GET_COLLISION_RISK %}
        M117 Filament inserted. Resuming print when confirmed...
        RESUME
    {% else %}
        M117 Filament Loaded
    {% endif %}


    
[gcode_macro _PURGE_MORE]
description: Purge additional filament (10 mm)
gcode:
    RESTORE_E_CURRENT
    M109 S{printer["gcode_macro PRINTER_VARS"].leveling_temp|int}
    RESPOND TYPE=command MSG="Purging filament..."
    G91
    G1 E10 F180
    G90
    M400
    SET_E_MIN_CURRENT

[gcode_macro CHECK_FILAMENT]
description: Check status of filament sensors
gcode:
    {% if 'filament_switch_sensor filament_sensor' not in printer %}
        M117 Error: No filament sensor configured! Exiting...            
    {% else %}
        {% if printer['filament_switch_sensor filament_sensor'].filament_detected == True %}
            M118 Filament Loaded
        {% else %}
            M117 No Filament Detected
        {% endif %}
    {% endif %}

            
            

; --- CALIBRATION MACROS ---
[gcode_macro INPUTSHAPER]
description: Start input shaper calibration
gcode:
    M117 Running input shaper calibration...
    G90
    G28
    {% set X_CENTER = printer.configfile.settings["stepper_x"].position_max / 2 %}
    {% set Y_CENTER = printer.configfile.settings["stepper_y"].position_max / 2 %}
    G1 X{X_CENTER} Y{Y_CENTER} F6000
    G1 Z10 F600
    SHAPER_CALIBRATE
    SAVE_CONFIG
    RESPOND MSG="Input shaper calibration complete."


[gcode_macro SCREWS_CALIBRATION]
description: Bed screws calibration (tilt adjustment)
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}
    SCREWS_TILT_CALCULATE
    RESPOND MSG="Bed screws calibration complete."


[gcode_macro CALIBRATE_Z]
description: Perform one-time interactive Z-offset calibration
gcode:
    M117 Starting PROBE_CALIBRATE
    G28
    PROBE_CALIBRATE 
    M117 PROBE_CALIBRATE complete. Check results.
    M117 Verifying Probe Accuracy...
    PROBE_ACCURACY

[gcode_macro GET_Z_OFFSET]
description: Report current Z‑offset (probe/nozzle)
gcode:
    {% if printer.gcode_move.gcode_offset.z is defined %} 
        {% set ZO = printer.gcode_move.gcode_offset.z|float %}
        RESPOND MSG="Active G-Code Z‑Offset: {ZO} mm"
    {% else %}
        RESPOND MSG="Z‑Offset not defined or Z axis not homed."
    {% endif %}


[gcode_macro SET_Z_OFFSET]
description: Set Z‑offset to an absolute value (and optionally save)
gcode:
    {% if params.VALUE is defined %}
        {% set ZV = params.VALUE|float %}
        SET_GCODE_OFFSET Z={ZV} MOVE=0
        RESPOND MSG="Z‑Offset set to {ZV} mm"
        {% if params.SAVE|lower == "true" %}
            SAVE_CONFIG
            RESPOND MSG="Z‑Offset saved permanently."
        {% endif %}
    {% else %}
        RESPOND MSG="Error: Missing VALUE=. Example: SET_Z_OFFSET VALUE=-0.45"
    {% endif %}


[gcode_macro PID_CALIBRATE_ALL]
description: Runs PID calibration for Extruder (240C) then Bed (80C), saving results.
gcode:
    SAVE_GCODE_STATE NAME=PID_CAL_STATE
    G28
    
    M117 Starting Extruder PID Tuning (240 °C)...
    
    ; --- 1. EXTRUDER PID CALIBRATION (240C for common filaments) ---
    PID_CALIBRATE HEATER=extruder TARGET=240
    
    ; Wait for temperatures to stabilize before proceeding
    M104 S0 ; Turn off extruder
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM=50
    
    M117 Extruder PID Complete. Saving config...
    SAVE_CONFIG
    
    M117 Starting Bed PID Tuning (80 °C)...
    
    ; --- 2. BED PID CALIBRATION (80C for common filaments) ---
    PID_CALIBRATE HEATER=heater_bed TARGET=80
    
    M117 Bed PID Complete. Saving config...
    SAVE_CONFIG
    
    M117 Full PID Calibration Complete!
    TURN_OFF_HEATERS
    RESTORE_GCODE_STATE NAME=PID_CAL_STATE    


[gcode_macro FILAMENT_SENSOR_CHECK]
description: Triggers delayed load if sensor is ready.
gcode:
    DELAY_LOAD_FILAMENT {rawparams}

[gcode_macro _GUPPY_LOAD_MATERIAL]
description: Guppy Commands for Screen to Load Filament
gcode: 
    DELAY_LOAD_FILAMENT {rawparams}


[gcode_macro _GUPPY_QUIT_MATERIAL]
description: Guppy Commands for Screen to Unload Filament
gcode: 
    UNLOAD_FILAMENT {rawparams}
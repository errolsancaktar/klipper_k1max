## Homing Override ##
## 01_homing_override.cfg ##
## Printer: K1 Max (Customized) ##

[homing_override]
axes: xyz
gcode:
  M220 S100
  FORCE_MOVE STEPPER=stepper_z DISTANCE=10 VELOCITY=5
  {% if 'gcode_macro PRINTER_VARS' not in printer %}
     {action_raise_error("ERROR: gcode_macro PRINTER_VARS not defined! Please add a placeholder.")}
  {% endif %}
  
  {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}

; --- DYNAMIC SPEED SETUP ---
  {% set speed_travel = 150 * 60 %} ; 9000 mm/min
  {% set Z_PARK_ABS = VARS.z_park|default(10.0)|float %}
  
  {% set speed_x_homing = printer.configfile.settings['stepper_x'].homing_speed|float * 60 %}
  {% set speed_y_homing = printer.configfile.settings['stepper_y'].homing_speed|float * 60 %}
  {% set speed_z_homing = printer.configfile.settings['stepper_z'].homing_speed|float * 60 %}

  ; =========================================================================
  ; 1. PRE-HOMING SETUP
  ; =========================================================================
  {% if home_all or not printer.toolhead.homed_axes %}
     SET_KINEMATIC_POSITION X=150 Y=150 Z=10
     
     SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=z_is_safe VALUE=0
     SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=x_ready VALUE=0
     SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=y_ready VALUE=0
     SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=z_ready VALUE=0
     SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=xy_moved VALUE=0
     BED_MESH_CLEAR
  {% endif %}

  ; =========================================================================
  ; 2. X Homing Logic
  ; =========================================================================
  {% if home_all or 'X' in params %}
    _IF_HOME_Z 
    _SET_XY_HOMING_CURRENT
    G28 X
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=x_ready VALUE=1
    G91 ; Relative positioning for back-off
    G1 X-5 F{speed_x_homing}
    G90 ; Absolute positioning
    G4 P200 
    _RESTORE_XY_RUN_CURRENT
  {% endif %}

  ; =========================================================================
  ; 3. Y Homing Logic
  ; =========================================================================
  {% if home_all or 'Y' in params %}
    _IF_HOME_Z 
    _SET_XY_HOMING_CURRENT
    G28 Y
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=y_ready VALUE=1
    G91 ; Relative positioning for back-off
    G1 Y5 F{speed_y_homing}
    G90 ; Absolute positioning
    G4 P200 
    _RESTORE_XY_RUN_CURRENT
  {% endif %}

  ; =========================================================================
  ; 4. Z Homing Logic (Fixed Homing Call)
  ; =========================================================================
  {% if home_all or 'Z' in params %}
    ; 1. Ensure X/Y are homed before Z
    {% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes %}
       {% if 'x' not in printer.toolhead.homed_axes %}
           G28 X
       {% endif %}
       {% if 'y' not in printer.toolhead.homed_axes %}
           G28 Y
       {% endif %}
    {% endif %}
    
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=z_ready VALUE=0
    
    ; 2. CRITICAL FIX: Safe Z move to lift toolhead clear of bed before XY center move
    {% set SAFE_Z_LIFT_ABS = VARS.z_safe_travel|default(10.0)|float %}
    G90
    G1 Z{SAFE_Z_LIFT_ABS} F{speed_travel}
    
    ; 3. Move to Z-probe position
    {% set POSITION_X = printer.configfile.settings['stepper_x'].position_max/2 %}
    {% set POSITION_Y = printer.configfile.settings['stepper_y'].position_max/2 %}
    G1 X{POSITION_X} Y{POSITION_Y} F{speed_travel}
    
    ; 4. Home Z
    G28 Z
    
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=z_ready VALUE=1
    G90
    G1 Z{Z_PARK_ABS} F{speed_travel}
  
    ; Optional: Run QGL if available
    {% if printer.quad_gantry_level and home_all %}
        QUAD_GANTRY_LEVEL
    {% endif %}
  {% endif %}
    
  RESTORE_E_CURRENT 
  G4 P500
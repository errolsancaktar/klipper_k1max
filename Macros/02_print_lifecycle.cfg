[gcode_macro START_PRINT]
description: Starts a print with full preparation, allowing for bed mesh calibration or loading a pre-set profile.
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set slicer_bed_temp = params.BED_TEMP|default(0)|float %}
    {% set config_bed_temp = VARS.bed_target|default(0)|float %}
    {% set final_bed_temp = [slicer_bed_temp, config_bed_temp]|max|default(70.0)|float %}
    {% set bed_temp = [final_bed_temp, 70.0]|max %}
    {% set extruder_temp = params.EXTRUDER_TEMP|default(VARS.extruder_target)|float %}
    {% set chamber_temp = params.CHAMBER_TEMP|default(VARS.chamber_target|default(0))|float %}
    {% set leveling_temp = VARS.leveling_temp|default(180.0)|float %}
    {% set meshing_temp = VARS.meshing_temp|default(150.0)|float %}
    
    # Grab Pre Print Bed Temp 
    {% set actual_starting_temp = printer.heater_bed.temperature %}
    SET_GCODE_VARIABLE MACRO=BED_SOAK VARIABLE=last_start_temp VALUE={actual_starting_temp}
    SET_GCODE_VARIABLE MACRO=PRINTER_VARS VARIABLE=current_bed_temp VALUE={bed_temp}
    SET_GCODE_VARIABLE MACRO=PRINTER_VARS VARIABLE=current_extruder_temp VALUE={extruder_temp}
    
    RESPOND PREFIX="START_PRINT" MSG="Bed Target Set To: {bed_temp}C"

    ; 1. Turn on Light
    SET_PIN PIN=caselight VALUE=1.0

    ; 2. START HEAT (NON-BLOCKING) & HOMING 
    RESPOND PREFIX="START_PRINT" MSG="Starting pre-heat and soak..."   
    _PRINT_PREPARE EXTRUDER_TEMP={leveling_temp} CHAMBER_TEMP={chamber_temp}
    BED_SOAK START=1 TARGET_TEMP={bed_temp}
    
    RESPOND PREFIX="START_PRINT" MSG="Homing all axes"
    G28
    
    RESPOND PREFIX="START_PRINT" MSG="Waiting for bed soak to complete at {bed_temp}C..."
    BED_SOAK WAIT=1 TARGET_TEMP={bed_temp}
    RESPOND PREFIX="START_PRINT" MSG="Waiting for leveling temp and nozzle clean..."
    NOZZLE_CLEAN START=0 WAIT=1 
    RESPOND PREFIX="START_PRINT" MSG="Checking for saved bed mesh profile..."
    BED_PROFILE_CHECK BED_TEMP={bed_temp} EXTRUDER_TEMP={meshing_temp}
    {% if VARS.mesh_is_new == 1 %}
        RESPOND PREFIX="START_PRINT" MSG="Mesh calibrated. Heating to final print temp: {extruder_temp}C"
    {% else %}
        RESPOND PREFIX="START_PRINT" MSG="Mesh loaded. Heating to final print temp: {extruder_temp}C"
    {% endif %}
    M109 S{extruder_temp} ; Final blocking wait for hotend
    M190 S{bed_temp}
    
    NOZZLE_PRIME
    SET_GCODE_VARIABLE MACRO=PRINTER_VARS VARIABLE=mesh_is_new VALUE=0   
    G90
    M83
    G1 F600 
    RESPOND PREFIX="START_PRINT" MSG="Print preparation complete, ready to start printing"

    ; 5. PRINT HOLD & FINAL START
    {% set hold_time_s = VARS.print_hold_time | default(0) | int %}
    
    {% if hold_time_s > 0 %}
        M117 Final Print Hold Active. Waiting {hold_time_s} seconds...
        G4 S{hold_time_s}
        SET_GCODE_VARIABLE MACRO=PRINTER_VARS VARIABLE=print_hold_time VALUE=0
        M117 Print Hold Complete. Starting print moves.
    {% else %}
        M117 No hold time set. Starting print immediately.
    {% endif %}

    RESPOND PREFIX="START_PRINT" MSG="Starting Current Print..."

[gcode_macro END_PRINT]
description: Standard end-print routine (cooldown, park, shutoff)
gcode:
    M400
    M104 S0 ; Turn extruder heater off
    M140 S0 ; Turn bed heater off
    
    ; 1. Park toolhead
    _PARK_POSITION 
    
    ; 2. Run Aux Cooling Loop (set to 40C by default)
    AUX_COOL_DOWN TEMP=40 
    
    ; 3. Shut off ALL remaining fans (including aux_fan)
    TURN_OFF_FANS

    ; 4. Turn off Lights
    SET_PIN PIN=caselight VALUE=0.0

    SET_IDLE_TIMEOUT TIMEOUT=10
    M117 Print Finished
    RESPOND MSG="Print Finished"

[gcode_macro CANCEL_EMERGENCY]
description: IMMEDIATELY stops heaters and flushes the print queue, skipping parking/long moves.
gcode:
    M117 EMERGENCY CANCEL!
    
    ; 1. CRITICAL: Execute the base Klipper cancel function first to flush the queue.
    BASE_CANCEL_PRINT
    
    ; 2. Stop safety systems immediately (heaters/fans)
    M104 S0                   ; Turn off hotend 
    M140 S0                   ; Turn off bed 
    TURN_OFF_FANS             ; Turn off all fans
    CLEAR_PAUSE               ; Clear any pause state

    ; 3. Minimal, non-blocking lift
    G91                       ; Relative positioning
    G0 Z5 F1000               ; Lift Z 5mm fast
    G90                       ; Absolute positioning

    ; 4. Turn off Lights
    SET_PIN PIN=caselight VALUE=0.0
    M117 Print aborted successfully.
                              



[gcode_macro PAUSE]
description: Pause print and park safely (Uses corrected Z-hop logic)
rename_existing: PAUSE_BASE
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set z_lift = params.Z|default(10)|float %}
    
    {% if printer["pause_resume"].is_paused|int == 0 %}
        
        ; 1. ⭐ FIX: Save the print state *BEFORE* the lift
        SAVE_GCODE_STATE NAME=PAUSE
        
        ; 2. Trigger Internal Pause
        PAUSE_BASE 
        
        ; 3. Manual Z-Lift
        G91
        G1 Z{z_lift} F900
        G90
        
        ; 4. Redirect state variables to PRINTER_VARS
        SET_GCODE_VARIABLE MACRO=PRINTER_VARS VARIABLE=pause_extruder_temp VALUE={printer.extruder.target}

        ; 5. Retract (ONLY IF HOT)
        {% set min_temp = printer.configfile.settings.extruder.min_extrude_temp|default(170)|float %}
        {% if printer.extruder.temperature >= min_temp %}
            G91
            G1 E-2 F2100 
            G90
        {% else %}
            {action_respond_info("Pause: Nozzle cold, skipping retraction.")}
        {% endif %}

        ; 6. Clear the print area using safe traversal
        _SAFE_TRAVERSE_BED

        ; 7. Final Park Move to the fixed parking spot
        SAFE_MOVE X={VARS.x_park|float} Y={VARS.y_park|float} F=6000
        
        SET_IDLE_TIMEOUT TIMEOUT=43200
    {% endif %}

[gcode_macro RESUME]
description: Resume a paused print (Restores Z-hop automatically)
rename_existing: RESUME_BASE
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set e = params.E|default(2.5)|float %}
    
    M117 Resuming print...
    
    ; 1. Restore Temperature (Wait for extruder)
    {% set saved_temp = VARS.pause_extruder_temp|default(0)|float %}
    {% if saved_temp > 0 %}
        M109 S{saved_temp}
        SET_GCODE_VARIABLE MACRO=PRINTER_VARS VARIABLE=pause_extruder_temp VALUE=0
    {% endif %}

    ; 2. Prime Nozzle (Only if hot)
    {% set min_temp = printer.configfile.settings.extruder.min_extrude_temp|default(170)|float %}
    {% if printer.extruder.temperature >= min_temp %}
        G91
        G1 E{e} F2100
        G90
    {% endif %}
    
    ; 3. ⭐ FIX: Restore Position. Since PAUSE saved the state *before* the lift,
    ;    RESTORE moves X/Y/Z directly back to the print height.
    RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=100
    
    ; 4. Resume Print Job
    RESUME_BASE
    
[gcode_macro HOLD_PRINT]
description: Sets a print hold time (in minutes) that START_PRINT will respect.
gcode:
    {% set minutes = params.MINUTES | default(0) | float %}
    {% set seconds = (minutes * 60) | int %}
    
    SET_GCODE_VARIABLE MACRO=PRINTER_VARS VARIABLE=print_hold_time VALUE={seconds}
    M117 Print HOLD set for {minutes} minutes.

[gcode_macro CANCEL_PRINT]
description: Cancel print safely (park, heaters off, fans off)
rename_existing: BASE_CANCEL_PRINT
gcode:
    M117 Cancelling Print
    M104 S0
    M140 S0
    TURN_OFF_FANS
    CLEAR_PAUSE
    
    ; Minimal Z-Lift using G0 (fast, since we are cancelling)
    G91
    G0 Z10 F3000
    G90
    
    ; ⭐ Use the safe park position macro
    _PARK_POSITION

    ; Turn off Lights
    SET_PIN PIN=caselight VALUE=0.0
    M84
    BASE_CANCEL_PRINT
[gcode_macro _PRINT_PREPARE]
description: Prepares extruder and chamber, caps temps at max values
gcode:
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    
    ; --- 1. Define Maximums ---
    {% set MAX_EXTRUDER = VARS.max_extruder_temp|default(280)|float %} 
    {% set MAX_CHAMBER = VARS.max_chamber_temp|default(60)|float %}
    {% set leveling_temp = VARS.leveling_temp | float %}
    
    ; --- 2. Define Requested Targets ---
    {% set target_extruder = params.EXTRUDER_TEMP|float %}
    {% set target_chamber = params.CHAMBER_TEMP|float %}

    ; --- 3. Safety Caps ---
    {% if target_extruder > MAX_EXTRUDER %}
        M117 WARNING: Extruder temp capped at {MAX_EXTRUDER}C.
        {% set target_extruder = MAX_EXTRUDER %}
    {% endif %}
    
    {% if target_chamber > MAX_CHAMBER %}
        M117 WARNING: Chamber temp capped at {MAX_CHAMBER}C.
        {% set target_chamber = MAX_CHAMBER %}
    {% endif %}

    SET_GCODE_VARIABLE MACRO=PRINTER_VARS VARIABLE=extruder_target VALUE={target_extruder}
    SET_GCODE_VARIABLE MACRO=PRINTER_VARS VARIABLE=chamber_target VALUE={target_chamber}

    ; Preheat extruder to 
    M104 S{target_extruder}
    
    {% if printer.chamber and target_chamber > 0 %}
        M141 S{target_chamber} 
    {% endif %}    
; =======================================================
; 4. TUNING TOOLS
; =======================================================

[gcode_macro TUNE_STALLGUARD]
description: Finds the MINIMUM sensitivity (Floor) for homing.
gcode:
    {% set AXIS = params.AXIS|default("X")|upper %}
    {% set MIN_VAL = params.MIN|default(50)|int %}
    {% set MAX_VAL = params.MAX|default(100)|int %}
    {% set STEP_VAL = params.STEP|default(5)|int %}
    
    {% if AXIS not in ['X', 'Y'] %}
        {action_raise_error("AXIS must be 'X' or 'Y'")}
    {% endif %}
    {% set stepper_name = "stepper_" ~ AXIS|lower %}
    
    {% set endstop_pos = printer.configfile.settings[stepper_name].position_endstop|float %}
    {% set max_pos = printer.configfile.settings[stepper_name].position_max|float %}
    
    # Set visual gap for inspection
    {% set gap_target = 20 %}
    {% if endstop_pos > (max_pos / 2) %}
        {% set gap_target = endstop_pos - 20 %}
    {% else %}
        {% set gap_target = endstop_pos + 20 %}
    {% endif %}

    # Safety Home
    {% if "z" not in printer.toolhead.homed_axes %}
        M118 Homing All Axes (Safety)...
        G28
    {% endif %}

    # --- SILENCE MESSAGES ---
    {% set VARS = printer["gcode_macro PRINTER_VARS"] %}
    {% set HOMING_CURRENT = VARS.homing_current|default(0.6)|float %}
    
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOMING_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOMING_CURRENT}
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=tuning_mode VALUE=1

    M118 =================================================
    M118 STARTING TUNING LOOP FOR {AXIS}
    M118 LOOK FOR: The lowest SGTHRS where 'trigger_phase' stops changing.
    M118 =================================================
    
    # --- SWEEP LOOP ---
    {% for sensitivity in range(MIN_VAL, MAX_VAL + 1, STEP_VAL) %}
        SET_TMC_FIELD STEPPER={stepper_name} FIELD=SGTHRS VALUE={sensitivity}
        M400 
        
        G28 {AXIS}
        M400 
        
        M118 --------------------------------------
        M118 TESTING SGTHRS: {sensitivity}
        ENDSTOP_PHASE_CALIBRATE STEPPER={stepper_name}
        
        G90
        G1 {AXIS}{gap_target} F12000
        M400
        
        G4 P1000 ; Wait 1 second
        
    {% endfor %}
    
    # --- RESTORE SETTINGS ---
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=tuning_mode VALUE=0
    
    {% set run_x = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set run_y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={run_x}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={run_y}
    
    {% set e_current = printer.configfile.settings['tmc2209 extruder'].run_current %}
    SET_TMC_CURRENT STEPPER=extruder CURRENT={e_current} HOLDCURRENT={e_current}
    
    M118 =================================================
    M118 TUNING COMPLETE. SCROLL UP AND FIND THE STABLE NUMBER.
    M118 =================================================

[gcode_macro TEST_FULL_SWEEP]
description: Tests for "False Triggers" using Long and Short moves.
gcode:
    # --- PARAMETERS ---
    {% set AXIS = params.AXIS|default("X")|upper %}
    {% set ITERATIONS = params.ITERATIONS|default(1)|int %}
    {% set SPEED = params.SPEED|default(300)|int * 60 %} # Default 300mm/s
    
    {% if AXIS not in ['X', 'Y'] %}
        {action_raise_error("AXIS must be 'X' or 'Y'")}
    {% endif %}
    {% set stepper_name = "stepper_" ~ AXIS|lower %}

    # --- SETUP BOUNDARIES (Safe Margins) ---
    {% set max_pos = printer.configfile.settings[stepper_name].position_max|float %}
    {% set min_pos = printer.configfile.settings[stepper_name].position_min|float %}
    
    # K1 Max Specific: Safe travel limits (avoid banging endstops)
    {% set start_point = max_pos - 10 %} 
    {% set end_point = min_pos + 10 %}

    {% if "z" not in printer.toolhead.homed_axes %}
        M118 Homing All Axes (Safety)...
        G28
    {% endif %}
    
    M118 --- Full Sweep Test (Long/Short) on {AXIS} ---
    
    # 1. Establish Baseline
    M118 1. Establishing Baseline Home...
    G28 {AXIS}
    M400
    M118 BASELINE:
    ENDSTOP_PHASE_CALIBRATE STEPPER={stepper_name}
    
    # 2. Long/Short Moves
    {% for i in range(ITERATIONS) %}
        M118 Loop {i+1}/{ITERATIONS}: Running Long/Short moves...
        G90
        # Long Move (Min)
        G1 {AXIS}{end_point} F{SPEED}
        M400
        # Long Move (Max)
        G1 {AXIS}{start_point} F{SPEED}
        M400
        # Short Move (Wiggle)
        G1 {AXIS}{start_point - 50} F{SPEED}
        G1 {AXIS}{start_point} F{SPEED}
        M400
    {% endfor %}
    
    # 3. Verification
    M118 3. Re-Homing to check for lost steps...
    G28 {AXIS}
    M400
    
    M118 RESULT:
    ENDSTOP_PHASE_CALIBRATE STEPPER={stepper_name}
    
    M118 Compare 'BASELINE' and 'RESULT'. If different, SGTHRS is too high (False Trigger).
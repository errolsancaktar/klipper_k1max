## M and G Code Defs ##
## 01_m-g_codes.cfg ##
## Printer: K1 Max (Customized) ##

[gcode_macro M600]
description: Standard M600 filament change entry point.
gcode:
    CHANGE_FILAMENT

[gcode_macro M900]
description: Set pressure advance
gcode:
    {% if 'K' in params %}
        {% if 'E' in params %}
            SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
        {% else %}
            SET_PRESSURE_ADVANCE ADVANCE={params.K}
        {% endif %}
    {% endif %}


[gcode_macro M117]
rename_existing: M117.1
gcode:
  {% if rawparams %}
    {% set escaped_msg = rawparams.split(';', 1)[0].split('\x23', 1)[0]|replace('"', '\\"') %}
    
    ; 1. Display on screen (This is what M117.1 would have done)
    SET_DISPLAY_TEXT MSG="{escaped_msg}" 
    
    ; 2. Log to console/host (The fix: Use action_respond_info)
    {action_respond_info(escaped_msg)}
  {% else %}
    SET_DISPLAY_TEXT
  {% endif %}




[gcode_macro M106]
description: "Set fan speed (Orca compatible)"
gcode:
    {% set fan_map = {
        0: "PART",      # Orca P0
        3: "EXHAUST",   # Orca P3 → Exhaust
        2: "AUX",    
    } %}
    {% set p = params.P|int if 'P' in params else 0 %}
    {% set fan = fan_map[p] if p in fan_map else fan_map[0] %}
    {% set speed = (params.S|float / 255 if 'S' in params else 1.0) %}
    SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro M107]
description: "Turn off fans. No P = all, P# = specific"
gcode:
    {% set fan_map = {
        0: "CPAP",
        3: "EXHAUST",
        # 2: "AUX",
    } %}
    {% if 'P' in params %}
        {% set p = params.P|int %}
        {% if p in fan_map %}
            SET_FAN_SPEED FAN={fan_map[p]} SPEED=0
        {% else %}
            RESPOND PREFIX="warn" MSG="Unknown fan index P{p}"
        {% endif %}
    {% else %}
        # No P -> turn off all mapped fans
        {% for f in fan_map.values() %}
            SET_FAN_SPEED FAN={f} SPEED=0
        {% endfor %}
    {% endif %}    

[gcode_macro M205]
description: Set square-corner velocity (alias for SET_VELOCITY_LIMIT)
gcode:
    {% if 'X' in params %}
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X}
    {% elif 'Y' in params %}
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.Y}
    {% endif %}

[gcode_macro G32]
description: Gantry leveling + nozzle clean + re‑home Z
gcode:
    SAVE_GCODE_STATE NAME=G32_STATE
    M117 Starting G32 (Home, Clean, Level)
    BED_MESH_CLEAR
    
    ; Pass default temperatures to G28 for the bed mesh check
    G28 BED=60 EXTRUDER=150
    
    NOZZLE_CLEAN
    G28 Z
    M117 G32 Complete
    RESTORE_GCODE_STATE NAME=G32_STATE


[gcode_macro PRINT_CALIBRATION]
description: Placeholder for print leveling calibration
gcode:


[gcode_macro INPUTSHAPER]
description: Start Input Shaper calibration using SHAPER_CALIBRATE
gcode:
    # Disable filament sensors before calibration
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
    SET_FILAMENT_SENSOR SENSOR=filament_sensor_2 ENABLE=0
    G90
    G28
    # Move to center of the bed for calibration
    {% set POSITION_X = printer.configfile.settings['stepper_x'].position_max/2 %}
    {% set POSITION_Y = printer.configfile.settings['stepper_y'].position_max/2 %}
    G1 X{POSITION_X} Y{POSITION_Y} F6000
    G1 Z10 F600
    SHAPER_CALIBRATE
    SAVE_CONFIG # Standard Klipper save command, replaced CXSAVE_CONFIG
    # Re-enable filament sensors
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
    SET_FILAMENT_SENSOR SENSOR=filament_sensor_2 ENABLE=1

[gcode_macro BEDPID]
description: Start PID tuning for the heated bed (100C target)
gcode:
    PID_CALIBRATE HEATER=heater_bed TARGET=100
    SAVE_CONFIG

[gcode_macro SCREWS_CALIBRATION]
description: Start Bed Screws Calibration
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
    G28 ; Home axes if not already homed
    {% endif %}
    SCREWS_TILT_CALCULATE
[gcode_macro CALIBRATE_Z_OFFSET]
description: Interactive macro to calibrate the Z-offset using a paper test.
gcode:
    {% set Z_PROBE_SPEED = 2.0 %} # Slow speed for final touch

    M117 Calibrating Z-Offset...

    # Ensure X and Y are homed (Z is homed inside _HOME_Z)
    G28 X Y

    # 1. Home Z to ensure we have a reference point
    _HOME_Z

    # 2. Go to the center of the bed
    G90
    G1 X150 Y150 F6000

    # 3. Move to the stored Z offset position
    # This uses the current Z-offset from the probe
    G1 Z{printer.gcode_macro._probe_helper_z_position.z_position} F{Z_PROBE_SPEED * 60}

    M117 Use PAPER or GAUGE now.

    # 4. Enter manual jogging mode
    M0 "Z-Offset Calibration: Adjust Z down slowly until paper drags, then click RESUME."

    # 5. After user confirms drag, read the new position
    {% set current_z = printer.toolhead.position.z %}

    # 6. Calculate the new Z-offset (Current position - Measured Z position)
    # The measured Z position is stored in the probe helper macro variable
    {% set new_offset = current_z - printer.gcode_macro._probe_helper_z_position.z_position|float %}

    M117 Applying new Z-Offset...

    # 7. Apply the new Z-offset
    SET_GCODE_OFFSET Z={new_offset} MOVE=1

    M118 New Z-Offset applied: {new_offset|round(3)}mm
    M117 Z-Offset Calibration Complete.

[gcode_macro CALIBRATE_BED_MESH]
description: Homes axes and creates the bed mesh profile "default".
gcode:
    M117 Calibrating Bed Mesh...

    G28

    # Run the bed mesh process (using the defined [bed_mesh] config)
    BED_MESH_CALIBRATE profile="default"
    BED_MESH_PROFILE SAVE="default"

    M117 Bed Mesh Calibration Complete. Profile Saved.

[gcode_macro CALIBRATE_ALL]
description: Executes all necessary calibration steps (Mesh only).
gcode:
    M117 Starting Full Calibration (Bed Mesh)...

    # 1. Homing is done inside CALIBRATE_BED_MESH
    CALIBRATE_BED_MESH

    M117 Full Calibration Complete!

########################################

## Test Speed Macro (TEST_SPEED)

########################################


[gcode_macro TEST_SPEED]
description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU
gcode:

    ##Set parameters with fallback to printer config values

    {% set speed     = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    {% set iterations = params.ITERATIONS|default(5)|int %}
    {% set accel     = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    {% set bound = params.BOUND|default(20)|int %}

    #Small pattern size should be passed as a parameter or defined globally.

    {% set smallpatternsize = params.SMALLPATTERNSIZE|default(20)|int %}

    #--- Large pattern bounding box (inset by 'bound') ---

    {% set x_min_base = printer.toolhead.axis_minimum.x %}
    {% if x_min_base < 0 %}
    {% set x_min_base = 0 %}
    {% endif %}
    {% set x_min = x_min_base + bound %}

    {% set y_min_base = printer.toolhead.axis_minimum.y %}
    {% if y_min_base < 0 %}
    {% set y_min_base = 0 %}
    {% endif %}
    {% set y_min = y_min_base + bound %}

    {% set x_max = printer.toolhead.axis_maximum.x - bound %}
    {% set y_max = printer.toolhead.axis_maximum.y - bound %}

    #--- Small pattern box at center ---

    {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
    {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
    {% set x_center_min = x_center - (smallpatternsize/2) %}
    {% set x_center_max = x_center + (smallpatternsize/2) %}
    {% set y_center_min = y_center - (smallpatternsize/2) %}
    {% set y_center_max = y_center + (smallpatternsize/2) %}

    #Save current gcode state (absolute/relative, etc)

    SAVE_GCODE_STATE NAME=TEST_SPEED

    #Output parameters to g-code terminal

    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }

    #Home and get initial position for comparison

    M400
    G28

    #Run Quad Gantry Level if configured and not applied (Specific to Klipper setups)

    {% if printer.configfile.settings.quad_gantry_level %}
        {% if printer.quad_gantry_level.applied == False %}
            QUAD_GANTRY_LEVEL
            G28 Z
        {% endif %}
    {% endif %}

    #Move and home again (improves endstop accuracy, especially hall effect)

    G90
    G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{3060}
    M400
    G28 X Y
    G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{3060}
    G4 P1000
    GET_POSITION # Record MCU position 1

    #Go to starting position

    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60} # FIXED: Removed escaped backslash ()

    #Set temporary velocity limits for the test

    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
    {% endif %}

    #Run the movement pattern for the specified number of iterations

    {% for i in range(iterations) %}

        #Large pattern diagonals

        G0 X{x_min} Y{y_min} F{speed60}
        G0 X{x_max} Y{y_max} F{speed60}
        G0 X{x_min} Y{y_min} F{speed60}
        G0 X{x_max} Y{y_min} F{speed60}
        G0 X{x_min} Y{y_max} F{speed60}
        G0 X{x_max} Y{y_min} F{speed60}

        #Large pattern box

        G0 X{x_min} Y{y_min} F{speed60}
        G0 X{x_min} Y{y_max} F{speed60}
        G0 X{x_max} Y{y_max} F{speed60}
        G0 X{x_max} Y{y_min} F{speed60}

        #Small pattern diagonals

        G0 X{x_center_min} Y{y_center_min} F{speed60}
        G0 X{x_center_max} Y{y_center_max} F{speed60}
        G0 X{x_center_min} Y{y_center_min} F{speed60}
        G0 X{x_center_max} Y{y_center_min} F{speed60}
        G0 X{x_center_min} Y{y_center_max} F{speed60}
        G0 X{x_center_max} Y{y_center_min} F{speed60}

        #Small pattern box

        G0 X{x_center_min} Y{y_center_min} F{speed60}
        G0 X{x_center_min} Y{y_center_max} F{speed60}
        G0 X{x_center_max} Y{y_center_max} F{speed60}
        G0 X{x_center_max} Y{y_center_min} F{speed60}

    {% endfor %}

    #Restore velocity limits to configured values

    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    #Re-home and get final position for comparison

    M400
    G28
    G90
    G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
    G4 P1000
    GET_POSITION # Record MCU position 2

    #Restore previous gcode state

    RESTORE_GCODE_STATE NAME=TEST_SPEED

[gcode_macro TEST_MACROS]
description: Runs a dry-run test of all core start-up macros (Homing, Mesh Fallback, Speeds, Purge path).
gcode:
    M117 Running Full Macro Test...

    ; Setup defensive velocity logic
    {% set SYS_MAX_ACCEL = printer.toolhead.max_accel|default(5000)|float %}
    {% set params = printer["gcode_macro PRINTER_VARS"]|default({}) %}
    {% set TARGET_ACCEL = params.variable_max_accel|default(12000)|float %}
    {% set MAX_VELOCITY = params.variable_max_velocity|default(500)|float %}
    {% set PURGE_LENGTH = params.variable_purge_length|default(100)|float %}

    ; If the target is greater than the system's hard limit, use the system limit.
    {% set FINAL_ACCEL = [TARGET_ACCEL, SYS_MAX_ACCEL]|min %}

    ; 1. Test Homing Override (G28)
    M117 Testing G28 Homing...
    G28

    ; 2. Test Velocity Limits (using the capped, safe value)
    M117 Testing SET_VELOCITY_LIMIT: ACCEL={FINAL_ACCEL|round(0)} VELOCITY={MAX_VELOCITY}
    SET_VELOCITY_LIMIT ACCEL={FINAL_ACCEL} VELOCITY={MAX_VELOCITY}
    G0 X150 Y150 F12000 ; Move at high speed

    ; 3. Test Static Bed Mesh Fallback (simulating no slicer parameters)
    M117 Testing Static Bed Mesh Fallback (Loading 'default')...
    BED_MESH_PROFILE LOAD="default"

    ; 4. Test Purge Path (G0 and G1 moves)
    M117 Testing Purge Path moves...
    G90                                   ; Absolute positioning
    G0 Z2.0 F3000                         ; Lift Z to start height
    G0 X0 Y0 F6000                        ; Move to start of purge

    G92 E0                                ; Reset extruder
    G1 X{PURGE_LENGTH} F6000          ; Move along purge path (dry-run, no E)

    G0 Z0.2 F3000                         ; Drop Z slightly
    G1 X0 F6000                           ; Wipe back

    M117 Macro Test Complete! Please run END_PRINT to park.
    
[gcode_macro GET_Z_OFFSET]
description: Reports the currently active Z-Offset value.
gcode:
    {% if printer.gcode_move.homing_data.probe_z_offset is defined %}
        {% set Z_OFFSET = printer.gcode_move.homing_data.probe_z_offset|float %}
        RESPOND MSG="Active Z-Offset (Probe/Nozzle Distance): {Z_OFFSET} mm"
    {% else %}
        RESPOND MSG="Z-Offset not defined or Z-Axis not homed."
    {% endif %}

[gcode_macro SET_Z_OFFSET]
description: Sets the Z-Offset to an absolute value, applies it immediately, and saves only if SAVE=True.
# Usage (Apply only): SET_Z_OFFSET VALUE=-0.45
# Usage (Apply and Save): SET_Z_OFFSET VALUE=-0.45 SAVE=True
gcode:
    {% if params.VALUE is defined %}
        {% set Z_VALUE = params.VALUE|float %}
        
        ; Sets the Z-Offset to the specified absolute value. MOVE=0 prevents accidental movement.
        SET_GCODE_OFFSET Z={Z_VALUE} MOVE=0
        
        RESPOND MSG="Z-Offset set to absolute value: {Z_VALUE|round(3)} mm."
        
        ; Optional: Save the configuration if requested
        {% if params.SAVE is defined and params.SAVE|lower == 'true' %}
            SAVE_CONFIG
            RESPOND MSG="New Z-Offset saved permanently via SAVE_CONFIG."
        {% endif %}
        
    {% else %}
        RESPOND MSG="Error: Missing VALUE= parameter. Example: SET_Z_OFFSET VALUE=-0.45"
    {% endif %}   
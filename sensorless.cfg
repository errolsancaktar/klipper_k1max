# Createdate: 2023/03/08

[force_move]
    enable_force_move: true

[gcode_macro xyz_ready]
variable_x_ready: 0
variable_y_ready: 0
variable_z_ready: 0
variable_xy_moved: 0
variable_z_moved: 0
variable_safe_z: 3
gcode:

[gcode_macro _IF_HOME_Z]
gcode:
  {% set READY_VARS = printer['gcode_macro xyz_ready'] %}
  # Check if PRINTER_PARAM exists, otherwise default to 10mm
  {% set Z_SAFE = printer["gcode_macro PRINTER_PARAM"].z_safe_g28|default(10)|float %}
  
  {% if READY_VARS.z_ready|int == 1 %}
    {% if printer.toolhead.position.z|int < 5 %}
      {% set z_park = 5.0 - printer.toolhead.position.z|int %}
      G91
      G1 z{z_park} F600
      G90
    {% endif %}
  {% else %}
    {% if READY_VARS.z_moved|int == 0 %}
      {% if printer.print_stats.z_pos|float <= 20.0 or printer.print_stats.power_loss == 1 %}
        FORCE_MOVE STEPPER=stepper_z DISTANCE={Z_SAFE} VELOCITY=10
      {% else %}
        FORCE_MOVE STEPPER=stepper_z DISTANCE=0.1 VELOCITY=10
      {% endif %}
      SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=z_moved VALUE=1
    {% endif %}
  {% endif %}

[gcode_macro _IF_MOVE_XY]
gcode:
  _IF_HOME_Z
  {% if printer['gcode_macro xyz_ready'].xy_moved|int == 0 %}
    # {action_respond_info("move xy\n")}
    # Fake position to allow force move
    SET_KINEMATIC_POSITION X=0 Y=0 Z=0
    FORCE_MOVE STEPPER=stepper_y DISTANCE=-14 VELOCITY=50
    FORCE_MOVE STEPPER=stepper_y DISTANCE=7 VELOCITY=50
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=xy_moved VALUE=1
    G4 P1000
  {% endif %}

[homing_override]
axes: xyz
gcode:
  M220 S100
  
  # --- Reset Status ---
  {% set homed_axes = printer.toolhead.homed_axes %}
  {% if not homed_axes %}
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=x_ready VALUE=0
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=y_ready VALUE=0
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=z_ready VALUE=0
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=xy_moved VALUE=0
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=z_moved VALUE=0
    BED_MESH_CLEAR
  {% endif %}

  # --- Check if Y is too far back (Safety) ---
  {% if 'x' in homed_axes and 'y' in homed_axes %}
    {% set position_y = printer.toolhead.position.y|int %}
    # Default to 300 if param missing
    {% set max_y = printer["gcode_macro PRINTER_PARAM"].max_y_position|default(300)|int %}
    {% if position_y >= max_y %}
      G91
      G0 Y-10 F3600
      G90
    {% endif %}
  {% endif %}

  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}

  # --- HOME X ---
  {% if home_all or 'X' in params %}
    _IF_MOVE_XY
    
    # Pre-home safety move if already homed
    {% if printer['gcode_macro xyz_ready'].x_ready|int == 1 %}
       {% set x_max = printer.configfile.settings['stepper_x'].position_max %}
       {% if (x_max - printer.toolhead.position.x)|round < 10 %}
          G91
          G1 x-10 F3600
          G90
          G4 P1000
       {% endif %}
    {% endif %}

    G28 X
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=x_ready VALUE=1
    
    # Move away
    G91
    G1 x-10 F3600
    G90
    G4 P2000
  {% endif %}

  # --- HOME Y ---
  {% if home_all or 'Y' in params %}
    _IF_MOVE_XY

    # Pre-home safety
    {% if printer['gcode_macro xyz_ready'].y_ready|int == 1 %}
       {% if printer.toolhead.position.y|round < 8 %}
          G91
          G1 y8 F3600
          G90
          G4 P1000
       {% endif %}
    {% endif %}

    G28 Y
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=y_ready VALUE=1
    
    # Move away
    G91
    G1 y10 F3600
    G90
    G4 P2000
  {% endif %}

  # --- HOME Z ---
  {% if home_all or 'Z' in params %}
    # Ensure Z safety
    {% if printer.print_stats.z_pos|float >= 260.0 %}
      FORCE_MOVE STEPPER=stepper_z DISTANCE=-8 VELOCITY=10
    {% endif %}

    # Move to Center
    {% set POSITION_X = printer.configfile.settings['stepper_x'].position_max/2 %}
    {% set POSITION_Y = printer.configfile.settings['stepper_y'].position_max/2 %}
    
    G90
    G1 x{POSITION_X} y{POSITION_Y} F3600
    
    G28 Z
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=z_ready VALUE=1
    
    # Lift Z
    G91
    G1 Z10 F600
    G90
  {% endif %}

  BED_MESH_PROFILE LOAD="default"
  G4 P500
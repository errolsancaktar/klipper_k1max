# --- K1/K1-MAX INTEGRATED MACROS (Derived from provided K1 config) ---
# This file integrates K1-MAX hardware specifics (fans, leveling calls)
# with global variable definitions and optimized print routines.
#
# NOTE: This assumes 'CX_PRINT_LEVELING_CALIBRATION' and 'CXSAVE_CONFIG'
# are defined in a separate machine-specific config file.

[gcode_macro PRINTER_PARAM]
# Replaces or augments PRINTER_VARS from utilities.cfg for K1 specifics
variable_z_safe_pause: 0.0 ; Safe Z height for pause
variable_fans: 3           ; Total fans (0, 1, 2)
variable_fan0_min: 25.0    ; Min PWM (0-255) for fan0 (Part Fan)
variable_fan1_min: 50.0    ; Min PWM (0-255) for fan1 (Chamber/Board Fan)
variable_fan2_min: 180.0   ; Min PWM (0-255) for fan2 (Aux/Printhead Fan)
variable_fan2_speed: 0.0   ; Stores fan2 speed before a pause
variable_hotend_temp: 0    ; Stores extruder target temp before pause
variable_e_min_current: 0.27 ; Extruder current for idle/cooldown
gcode:
  # Empty G-code block for macro variables

[gcode_macro PRINT_START]
# Mandatory parameters from Slicer (Set in Slicer Custom Start G-code)
# Example: PRINT_START BED_TEMP=[bed_temperature_request] EXTRUDER_TEMP=[extruder_temperature_request]
gcode:
    {% set BED = params.BED_TEMP|float %}
    {% set EXTRUDER = params.EXTRUDER_TEMP|float %}

    # 1. Start heating simultaneously
    M140 S{BED}                                ; Set Bed Temp
    M104 S{EXTRUDER}                           ; Set Extruder Temp

    # 2. Home the printer (G28 macro handles safety)
    G28

    # 3. Wait for Bed Temperature (M190 macro handles the wait)
    M190 S{BED}

    # 4. Wait for Extruder Temperature (M109 macro handles the wait)
    M109 S{EXTRUDER}

    # 5. Perform Bed Mesh / Probing (Use your K1's built-in macro if you have one, or define a simplified one)
    # A simple G32 can trigger an automated probe sequence.
    # Replace this with the K1's specific leveling command if different.
    # Example for K1's factory leveling: QUAD_GANTRY_LEVEL or similar
    # If not using a specific K1 macro, add your bed mesh command here:
    # G29
    # or
    # BED_MESH_CALIBRATE

    # 6. Purge Line / Prime (Adjust coordinates for your K1 build plate)
    G92 E0                                     ; Reset Extruder
    G0 X0 Y0 F6000                             ; Move to front-left corner
    G0 Z0.2 F300                               ; Move to Z=0.2 for priming
    G91                                        ; Relative positioning
    G1 X100 E20 F1500                          ; Prime line (100mm line, 20mm extrusion)
    G90                                        ; Absolute positioning
    G92 E0                                     ; Reset Extruder again
    G0 Z10 F6000                               ; Lift nozzle 10mm off bed
    
    # 7. Move to Start Position (Slicer will usually handle this, but for safety)
    # G0 X10 Y10 F6000

  
[gcode_macro PRINT_END]
gcode:
    # 1. Turn off heating
    M104 S0                                    ; Turn off hotend
    M140 S0                                    ; Turn off bed

    # 2. Park toolhead
    G91                                        ; Relative positioning
    G1 Z10 F3000                               ; Raise Z 10mm (or max height if it is less than 10)
    G90                                        ; Absolute positioning
    G0 X0 Y220 F6000                           ; Park toolhead safely at the front-center (adjust Y for your bed size)

    # 3. Turn off fan and disable steppers
    M106 S0                                    ; Turn off parts fan
    M84                                        ; Disable motors  

# --- Extruder Current Management (Heat Creep Mitigation) ---

[gcode_macro SET_E_MIN_CURRENT]
description: Lowers extruder motor current to reduce heat creep when idle.
gcode:
  {% set e_current = printer['gcode_macro PRINTER_PARAM'].e_min_current %}
  M400 # Wait for moves to finish
  SET_TMC_CURRENT STEPPER=extruder CURRENT={e_current} HOLDCURRENT={e_current}
  G4 P2000

[gcode_macro RESTORE_E_CURRENT]
description: Restores extruder motor current to configured run_current.
gcode:
  {% set e_current = printer.configfile.settings['tmc2209 extruder'].run_current %}
  M400
  SET_TMC_CURRENT STEPPER=extruder CURRENT={e_current} HOLDCURRENT={e_current}
  G4 P2000

# --- Material Handling Macros (Specific to K1/K1-MAX) ---

[gcode_macro LOAD_MATERIAL_CLOSE_FAN2]
description: Prepares printer for material load by saving fan2 state and restoring current.
variable_fan2_value: 0
gcode:
  SAVE_GCODE_STATE NAME=MaterialMoveState
  {% if printer['output_pin fan2'].value > 0.0 %}
    SET_GCODE_VARIABLE MACRO=LOAD_MATERIAL_CLOSE_FAN2 VARIABLE=fan2_value VALUE={printer['output_pin fan2'].value}
    M107 P2 ; Turn off fan2 (Aux/Printhead Fan)
  {% endif %}
  RESTORE_E_CURRENT ; Use full current for extrusion

[gcode_macro LOAD_MATERIAL_RESTORE_FAN2]
description: Restores fan2 state and drops extruder current after material load.
gcode:
  {% set fan2_value = printer['gcode_macro LOAD_MATERIAL_CLOSE_FAN2'].fan2_value|float %}
  RESTORE_GCODE_STATE NAME=MaterialMoveState
  {% if fan2_value > 0.0 %}
    {% set min_pwm = printer["gcode_macro PRINTER_PARAM"].fan2_min|float %}
    ; Calculate original Slicer (0-255) value to restore fan speed correctly
    ; This complex calculation ensures the fan starts reliably using the minimum PWM override (M106 P2 S<s_value>)
    {% set s_value = (fan2_value * 255.0 - min_pwm) * 255.0 / (255.0 - min_pwm) %}
    M106 P2 S{s_value}
    SET_GCODE_VARIABLE MACRO=LOAD_MATERIAL_CLOSE_FAN2 VARIABLE=fan2_value VALUE=0.0
  {% endif %}
  SET_E_MIN_CURRENT ; Drop current back down for idle

[gcode_macro LOAD_MATERIAL]
description: Loads material, heating the nozzle first and running high-flow extrusion.
gcode:
  LOAD_MATERIAL_CLOSE_FAN2
  ; Assumes default_extruder_temp is defined in custom_macro config
  M109 S{printer.custom_macro.default_extruder_temp} 
  G91 ; Relative positioning
  G1 E80 F180 ; Fast, long extrusion
  LOAD_MATERIAL_RESTORE_FAN2

[gcode_macro QUIT_MATERIAL]
description: Unloads material using the K1's tuned multi-stage retraction sequence.
gcode:
  SAVE_GCODE_STATE NAME=MaterialMoveState
  RESTORE_E_CURRENT
  ; Assumes default_extruder_temp is defined in custom_macro config
  M109 S{printer.custom_macro.default_extruder_temp}
  M83 ; Relative extrusion
  
  ; --- Highly tuned K1 retraction sequence (DO NOT MODIFY) ---
  G1 E100 F300 ; Push slightly to release grip
  G1 E-15 F3000 ; Fast initial long retraction
  G1 E-22.4700 F2400
  G1 E-6.4200 F1200
  G1 E-3.2100 F720
  G1 E5.0000 F356
  G1 E-5.0000 F384
  G1 E5.0000 F412
  G1 E-5.0000 F440
  G1 E5.0000 F467
  G1 E-5.0000 F495
  G1 E5.0000 F523
  G1 E-5.0000 F3000
  G1 E-15 F3000 ; Final pull
  
  SET_E_MIN_CURRENT
  RESTORE_GCODE_STATE NAME=MaterialMoveState

# --- K1 Specific Fan Overrides (Handles Min PWM Threshold) ---

[gcode_macro M106]
description: Override to handle K1 minimum fan PWM starting threshold.
gcode:
  {% set fans = printer["gcode_macro PRINTER_PARAM"].fans|int %}
  {% set fan = 0 %}
  {% set value_255 = 0 %}
  
  {% if params.P is defined %}
    {% set fan = params.P|int %}
    {% if fan >= fans %}
      {% set fan = 0 %} ; Default to fan0 if P is out of range
    {% endif %}
  {% endif %}
  
  {% set s_param = params.S|default(255)|float %}
  {% set fan_min = printer["gcode_macro PRINTER_PARAM"]["fan%s_min" % fan]|float %}
  
  {% if s_param > 0 %}
    ; Calculate usable PWM range (255 - fan_min)
    {% set usable_range = 255.0 - fan_min %}
    ; Scale requested speed (0-255) to the usable range
    {% set scaled_value = usable_range / 255.0 * s_param %}
    ; Add the minimum threshold back
    {% set value_255 = fan_min + scaled_value %}
  {% endif %}
  
  {% if value_255 >= 255 %}
    {% set value_255 = 255 %}
  {% endif %}
  
  ; Fan value must be converted back to 0.0 - 1.0 scale for SET_PIN
  SET_PIN PIN=fan{fan} VALUE={value_255 / 255.0}

[gcode_macro M107]
description: Override to turn off fans using P parameter.
gcode:
  {% set fans = printer["gcode_macro PRINTER_PARAM"].fans|int %}
  {% if params.P is defined %}
    {% if params.P|int < fans %}
      SET_PIN PIN=fan{params.P|int} VALUE=0
    {% else %}
      SET_PIN PIN=fan0 VALUE=0 ; Turn off fan0 if P is out of range
    {% endif %}
  {% else %}
    SET_PIN PIN=fan0 VALUE=0
    SET_PIN PIN=fan2 VALUE=0
  {% endif %}

[gcode_macro M141]
description: Set Chamber temperature with slicers (M141 S<temp>).
gcode:
  {% if 'S' in params|upper %}
    {% set target_temp = params.S|int %}
    
    ; Ensure chamber fan (fan1) is managed for cooling/heating
    {% if target_temp > printer.temperature_fan.chamber_fan.temperature %}
      SET_PIN PIN=fan1 VALUE=255 ; Max fan for cooling
    {% else %}
      SET_PIN PIN=fan1 VALUE=0
    {% endif %}
    
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber_fan TARGET={target_temp}

    ; If target is 0, explicitly turn off the fan control
    {% if target_temp == 0 %}
        SET_PIN PIN=fan1 VALUE=0
    {% endif %}
  {% endif %}

# --- Delayed G-code for Hotend Cool Down ---

[delayed_gcode wait_temp]
gcode:
  {% set cur_temp = printer.extruder.temperature %}
  {% if cur_temp|int < 40 %}
    WAIT_TEMP_END
  {% else %}
    UPDATE_DELAYED_GCODE ID=wait_temp DURATION=5 ; Check again in 5 seconds
  {% endif %}

[gcode_macro WAIT_TEMP_START]
description: Starts monitoring hotend temperature and turns on fan0 for cooldown.
gcode:
  {action_respond_info("Hotend cooldown sequence started.")}
  UPDATE_DELAYED_GCODE ID=wait_temp DURATION=1
  M106 P0 S255 ; Max fan0 speed for fast cooling

[gcode_macro WAIT_TEMP_END]
description: Ends the cooldown monitoring and turns off fan.
gcode:
  {action_respond_info("Hotend cooldown complete. Safe to idle.")}
  UPDATE_DELAYED_GCODE ID=wait_temp DURATION=0
  M106 P0 S0

# --- Leveling and Calibration Overrides ---

[gcode_macro G29]
description: Comprehensive K1 leveling and calibration routine.
gcode:
  {% set bed_temp = printer.custom_macro.default_bed_temp %}
  {% set extruder_temp = printer.custom_macro.g28_ext_temp %}
  {% set nozzle_clear_temp = printer.custom_macro.default_extruder_temp %}

  ; Disable filament sensors during bed leveling
  SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
  SET_FILAMENT_SENSOR SENSOR=filament_sensor_2 ENABLE=0

  G28
  BED_MESH_CLEAR
  
  ; Nozzle Clear requires hotend and bed to be at certain temps
  NOZZLE_CLEAR HOT_MIN_TEMP={extruder_temp} HOT_MAX_TEMP={nozzle_clear_temp} BED_MAX_TEMP={bed_temp}
  
  ACCURATE_G28
  M204 S5000
  SET_VELOCITY_LIMIT ACCEL_TO_DECEL=5000
  
  BED_MESH_CALIBRATE 
  BED_MESH_OUTPUT
  
  ; Park after mesh for user access
  {% set max_x = printer.toolhead.axis_maximum.x|float %}
  {% set max_y = printer.toolhead.axis_maximum.y|float %}
  G1 X{max_x - 10.0} Y{max_y / 2} F2000
  
  CXSAVE_CONFIG ; K1 specific config save
  TURN_OFF_HEATERS
  
  ; Re-enable sensors
  SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
  SET_FILAMENT_SENSOR SENSOR=filament_sensor_2 ENABLE=1

[gcode_macro ACCURATE_G28]
description: K1 Z-specific homing call.
gcode:
  ACCURATE_HOME_Z

# --- Print Routines ---

[gcode_macro START_PRINT]
description: K1 optimized print start routine with optional non-blocking soak.
gcode:
    {% set BED_TEMP = params.BED|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(200)|float %}
    {% set CHAMBER_TEMP = params.CHAMBER|default(0)|float %}
    {% set SOAK_DURATION = params.SOAK_TIME|default(0)|int %} ; New parameter
    
    {% set LEVELING_TEMP = 150 %}
    {% set SOAK_OFFSET = 15 %}
    {% set CALCULATED_SOAK_TEMP = BED_TEMP + SOAK_OFFSET %}
    {% set MAX_EXTRUDER_TEMP = printer.configfile.settings.extruder.max_temp|float %}
    
    {% if CALCULATED_SOAK_TEMP > MAX_EXTRUDER_TEMP %}
        {% set SOAK_TEMP = MAX_EXTRUDER_TEMP %}
    {% else %}
        {% set SOAK_TEMP = CALCULATED_SOAK_TEMP %}
    {% endif %}
    
    RESPOND MSG="--- Slicer Parameters Received ---"
    RESPOND MSG="Bed Temp: {BED_TEMP}째C | Extruder Temp: {EXTRUDER_TEMP}째C | Soak Time: {SOAK_DURATION}s"
    
    ; 1. Initial Bed Heat to Soak Temp (Non-blocking)
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={SOAK_TEMP}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={LEVELING_TEMP}
    
    ; 2. (Optional) Run HEAT_SOAK from prep.cfg - Highly Recommended
    {% if SOAK_DURATION > 0 %}
      RESPOND MSG="Starting Non-Blocking HEAT_SOAK for {SOAK_DURATION} seconds."
      HEAT_SOAK TARGET={SOAK_TEMP} DURATION={SOAK_DURATION}
      ; Note: This HEAT_SOAK must be defined in prep.cfg
    {% endif %}

    ; 3. Leveling Preparation
    ; Wait for bed to reach at least the target temp *or* soak temp if not soaking
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={LEVELING_TEMP}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={LEVELING_TEMP}
    
    ACCURATE_G28
    CX_PRINT_LEVELING_CALIBRATION ; K1 QGL/Leveling Call
    
    ; 4. Set and Wait for Final Extruder Temperature (Blocking Wait)
    RESPOND MSG="Setting and Waiting for Extruder to reach {EXTRUDER_TEMP}째C"
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={EXTRUDER_TEMP}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={EXTRUDER_TEMP} MAXIMUM={EXTRUDER_TEMP+5}
    
    ; 5. Wait for Final Bed Temperature (Blocking Wait)
    RESPOND MSG="Heating Bed to final {BED_TEMP}째C"
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={BED_TEMP}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={BED_TEMP}

    ; 6. Prime and Start
    NOZZLE_PRIME

[gcode_macro NOZZLE_PRIME]
description: Performs a two-line purge/prime sequence at the front edge of the bed.
gcode:
   M117 Priming Nozzle
    G92 E0                   ; Reset extruder
    
    ; --- SAFETY CHECK FOR RETRACTION ---
    {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp|float %}
        G1 E-3 F1800 ; Retract slightly ONLY if hot enough
    {% else %}
        RESPOND MSG="WARNING: Too cold for initial retraction in NOZZLE_PRIME. Skipping E-3."
    {% endif %}
    
    G1 X10 Y10 F10000          ; Move to start of prime line
    G1 Z0.3 F500             ; Drop Z to print height
    G92 E0                   ; Zero extruder before starting prime line
    G1 E3 F500               ; Push out material before main line

    G92 E0                   ; Zero extruder again
    G1 E-0.30000 F3600       ; Retract to relieve pressure

    ; First prime line
    G1 Z0.2500 F1000         ; Drop to first layer height
    G1 X250 Y10 E50 F1000     ; Draw long prime line (adjust X length for K1 bed size)

    G92 E0                   ; Zero extruder
    G1 E-0.30000 F5400       ; Final retract
    G1 Z10 F500              ; Lift Z clear of the bed

# --- Pause, Resume, Cancel Routines (with current and fan management) ---

[gcode_macro PAUSE]
description: Pause the actual running print, implementing K1 safe park and current reduction.
rename_existing: PAUSE_BASE # Renames the default Klipper PAUSE
variable_extrude: 2.0
gcode:
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  {% set max_z = printer.configfile.settings['stepper_z'].position_max|float %}
  {% set y_park = printer.toolhead.axis_maximum.y / 2 %}
  {% set x_park = printer.toolhead.axis_maximum.x|float - 10.0 %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% set z_safe = 0.0 %}
  
  ; Calculate safe Z lift (K1 specific logic)
  {% if act_z < 48.0 %}
    {% set z_safe = 50.0 - act_z %} ; Lift to Z50 if below Z48
  {% elif act_z < (max_z - 2.0) %}
    {% set z_safe = 2.0 %} ; Lift 2mm if ample room
  {% elif act_z < max_z %}
    {% set z_safe = max_z - act_z %} ; Lift to max_z
  {% endif %}
  
  SET_GCODE_VARIABLE MACRO=PRINTER_PARAM VARIABLE=z_safe_pause VALUE={z_safe|float}
  
  PAUSE_BASE # Call the default Klipper pause logic
  
  G91
  SET_GCODE_VARIABLE MACRO=PRINTER_PARAM VARIABLE=hotend_temp VALUE={printer.extruder.target}
  M104 S140 ; Drop hotend temp for safety
  
  {% if "xyz" in printer.toolhead.homed_axes %}
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E-1.0 F180
      G1 E-{E} F4000 ; Retract
    {% endif %}
    G1 Z{z_safe} F600 ; Lift
    M400
    G90
    G1 X{x_park} Y{y_park} F30000 ; Park
  
    SET_GCODE_VARIABLE MACRO=PRINTER_PARAM VARIABLE=fan2_speed VALUE={printer['output_pin fan2'].value}
    M106 P2 S0 ; Turn off fan2 (Aux/Printhead Fan)
    SET_E_MIN_CURRENT ; Reduce extruder current
  {% else %}
    {action_respond_info("Printer not homed, skipping park/retraction.")}
  {% endif %}


[gcode_macro RESUME]
description: Resume the current print, restoring temperature, fans, and current.
rename_existing: RESUME_BASE # Renames the default Klipper RESUME
gcode:
  RESTORE_E_CURRENT ; Restore extruder current
  
  {% set hotend_temp = printer["gcode_macro PRINTER_PARAM"].hotend_temp|float %}
  {% set fan2_speed = printer["gcode_macro PRINTER_PARAM"].fan2_speed|float %}

  M109 S{hotend_temp} ; Wait for target temperature
  
  {% if fan2_speed > 0.0 %}
    {% set min_pwm = printer["gcode_macro PRINTER_PARAM"].fan2_min|float %}
    ; Calculate original Slicer (0-255) value to restore fan speed correctly
    {% set s_value = (fan2_speed * 255.0 - min_pwm) * 255.0 / (255.0 - min_pwm) %}
    M106 P2 S{s_value} ; Restore Aux/Printhead fan speed
  {% endif %}
  
  RESUME_BASE ; Call the default Klipper resume logic

# Correcting END_PRINT_POINT to ensure it is defined before its use in END_PRINT

[gcode_macro END_PRINT_POINT]
description: Safely retract, lift, and park the toolhead without turning off all heaters.
gcode:
  {% set max_z = printer.configfile.settings['stepper_z'].position_max|float %}
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  
  {% if "xyz" in printer.toolhead.homed_axes %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set z_lift = 2.0 %} 
    
    G91 ; Relative positioning
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E-1.0 F180
      G1 E-{E} F4000 ; Retract
    {% endif %}
    
    G1 Z{z_lift} F600 ; Lift 2mm
    G90 ; Absolute positioning
    
    {% set y_park = printer.toolhead.axis_maximum.y / 2 %}
    {% set x_park = printer.toolhead.axis_maximum.x|float - 10.0 %}
    G1 X{x_park} Y{y_park} F30000 ; Park
    
    ; If Z is not near max, lift to a high position for access
    {% if act_z + z_lift < max_z - 2.0 %}
      G91
      G1 Z{max_z - (act_z + z_lift)} F600 ; Lift to near max Z
      G90
    {% endif %}
  {% else %}
    {action_respond_info("End print aborted: axes not homed.")}
  {% endif %}


[gcode_macro END_PRINT]
description: Final cleanup, turn off everything, park, and start cool-down routine.
gcode:
  EXCLUDE_OBJECT_RESET
  M220 S100 ; Reset speed factor
  
  ; Set motion limits back to the high defaults
  SET_VELOCITY_LIMIT ACCEL=8000 ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel / 2}
  
  TURN_OFF_HEATERS
  M107 P1 ; Turn off Chamber/Board Fan (fan1)
  M107 P2 ; Turn off Aux Fan (fan2)
  
  END_PRINT_POINT ; Retract, lift, and park the toolhead
  
  WAIT_TEMP_START ; Start hotend cool-down monitoring
  
  M84 ; Disable steppers
  
[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  END_PRINT
  CANCEL_PRINT_BASE

# --- Other K1 Overrides/Utilities ---

[gcode_macro M205]
description: Sets Square Corner Velocity (Klipper SET_VELOCITY_LIMIT)
gcode:
  {% if 'X' in params or 'Y' in params %}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X|default(params.Y)}
  {% endif %}

[gcode_macro M900]
description: Sets Pressure Advance (Klipper SET_PRESSURE_ADVANCE)
gcode:
  {% if 'K' in params %}
    {% if 'E' in params %}
      SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
    {% else %}
      SET_PRESSURE_ADVANCE ADVANCE={params.K}
    {% endif %}
  {% endif %}



[gcode_macro M109]
rename_existing: M109_PRE_MACRO
gcode:
    {% set t = params.S|float %}
    M104 S{t}                                     ; Set hotend temp
    {% if t != 0 %}
        M109_PRE_MACRO S{t}                       ; Wait for hotend temp
    {% endif %}

[gcode_macro M190]
rename_existing: M190_PRE_MACRO
gcode:
    {% set t = params.S|float %}
    M140 S{t}                                     ; Set bed temp
    {% if t != 0 %}
        M190_PRE_MACRO S{t}                       ; Wait for bed temp
    {% endif %}

[gcode_macro M140]
rename_existing: M140_PRE_MACRO
gcode:
    M140_PRE_MACRO {raw}

[gcode_macro M104]
rename_existing: M104_PRE_MACRO
gcode:
    M104_PRE_MACRO {raw}

[gcode_macro G90]
gcode:
    SET_GCODE_OFFSET Z=0.0
    G90

[gcode_macro G91]
gcode:
    G91

[gcode_macro M220]
gcode:
    SET_VELOCITY_RATE S={params.S}

[gcode_macro M221]
gcode:
    SET_FLOW_RATE S={params.S}
